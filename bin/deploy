#!/bin/bash

# Import utils.h
. $(dirname ${BASH_SOURCE[0]})/utils.sh
RequireDocker
PermissionsCheck

function CheckDeployArguments()
{
    if ! [ $# = 3 ]; then
        echo $@
        echo "USE: ${BASH_SOURCE[0]} <APPLICATION_NAME> <PROVIDER> <DATA_SOURCE>" 1>&2
        exit 1
    fi
}

CheckDeployArguments $@

__qi_app_name=$1
__qi_provider=$2
__qi_datasource=$3

# Tags and pushes an image to a remote registry.
# ARGUMENTS:
#   LOCAL_IMAGE - Docker image name on the local machine
#   REGISTRY    - The remote Container Registry URL
#.
# Returns: the remote image name as REMOTE_IMAGE.
#
function PushToRemote()
{
    LOCAL_IMAGE=$1
    REGISTRY=$2

    REMOTE_IMAGE="${REGISTRY}/${LOCAL_IMAGE}:dep.$(id -u -n $RUID)"

    docker tag ${LOCAL_IMAGE} ${REMOTE_IMAGE} > /dev/null
    docker push ${REMOTE_IMAGE} > /dev/null

    echo ${REMOTE_IMAGE}
}

export -f PushToRemote

__qi_resource_data="$__qi_app_name++$__qi_provider++$__qi_datasource++$(id -urn $RUID)"

__qi_config_name="${__qi_provider}-config"
__qi_config_mount=/.persistant_data
__qi_resource_name="${__qi_app_name}-$(GetId $__qi_resource_data)"
echo $__qi_resource_name

. $(dirname ${BASH_SOURCE[0]})/${__qi_provider} \
    $__qi_config_name \
    $__qi_config_mount \
    $__qi_app_name \
    $__qi_resource_name \
    $__qi_datasource
