#!/bin/bash

function GetLocation()
{
    echo "us-east"
}

function GetRegistry()
{
    local _resources=$1
    echo "us.icr.io/${_resources}"
}

function CopyData
{
    :
}

function GetPlatformContainer()
{
    docker pull ibmcom/ibm-cloud-developer-tools-amd64
}

function Login()
{
    local _container_name=$1
    local _container_mount=$2

    docker run \
        -it \
        -e IBMCLOUD_CONFIG_HOME=${_container_mount} \
        --name $_container_name \
        --label qi_container_type=login-config \
        --mount type=volume,target=${_container_mount} \
        ibmcom/ibm-cloud-developer-tools-amd64 \
            ibmcloud login --sso

    _IBMCLOUD_KEY="${_container_mount}/cn.key"

    # Provide a shareable docker command for platform container.
    _docker_cmd="docker run \
        -e IBMCLOUD_CONFIG_HOME=${_container_mount} \
        --rm \
        --volumes-from ${_container_name} \
        ibmcom/ibm-cloud-developer-tools-amd64"

    IBMCLOUD="${_docker_cmd} ibmcloud"
}

function Provision
{
    local _resources=$1
    local _location=$2
    local _datasource=$3

    # Setup Container Registry
    $IBMCLOUD plugin install container-registry
    $IBMCLOUD cr namespace-add $_resources
    $IBMCLOUD iam api-key-create cn-key -d "CN-generated key" --file "$_IBMCLOUD_KEY"
}

function PrepareDocker
{
    $_docker_cmd cat $_IBMCLOUD_KEY | jq '{apikey}["apikey"]' |\
        docker login \
        -u iamapikey \
        --password-stdin \
        us.icr.io
}

function Deploy
{
    local _application="$1"
    local _datasource="$2"
    local _image="$3"
    local _location="$4"
    local _auth_config="$5"
}

function ConnectToServer
{
    :
}
